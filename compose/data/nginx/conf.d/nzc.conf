include snippets/limits.conf; 

server {
    listen      80 default_server;
    listen      [::]:80 default_server;
    listen      443 http2 ssl default_server;
    listen      [::]:443 http2 ssl default_server;  
    root        /usr/share/nginx/html;
    include     snippets/server_env.conf;
    include     snippets/ssl.conf; 

    add_header X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
    add_header X-XSS-Protection "1; mode=block";
    
    map $http_user_agent $game_agent {
        default 0;
        ~*^(Valve\/Steam HTTP Client 1.0)   1;
    }
    
    location / {
        allow all;
        autoindex on;
    }   

    location /robots.txt {
        return 200 "User-agent: *\nDisallow: /";
    }
    
    location ~* \.(ht|php$) {
        deny all;
    }

    location /fastdl {
        gzip on;
        gzip_disable "msie6";
        gzip_comp_level 6;

        if ($game_agent) {
            limit_conn per_vhost 55;
            
            limit_req           zone=per_ip rate=60/s;
            limit_rate_after    50m;
            limit_rate          15m;
        }
    }

    location ~* ^/fastdl/.*\.(lua|as|cfg|sh|exe|rc|lst|scr)$ {
        deny all;
    }
    
    location /searx {
        access_log /dev/null;
        error_log /dev/null;
        
        allow 127.0.0.0/8;
        allow 172.0.0.0/8;
        allow 192.0.0.0/8;
        include snippets/private/admin_ips.conf;
        deny all;

        proxy_pass "http://searxng:8080";
        proxy_set_header   Host             $http_host;
        proxy_set_header   Connection       $http_connection;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_set_header   X-Scheme         $scheme;
        proxy_set_header   X-Script-Name    /searx;
    }
}
