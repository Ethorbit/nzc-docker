map $http_user_agent $steam_user_agent {
    default 0;
    "~^(Valve\/Steam HTTP Client 1.0)"   1;
}

include    snippets/limits.conf;
add_header X-Robots-Tag "noindex, nofollow, nosnippet, noarchive";
add_header X-XSS-Protection "1; mode=block";

# Default (Redirects to Site)
server { 
    include     snippets/listen.conf;
    server_name "${PUBLIC_DOMAIN_NAME}" "${PRIVATE_DOMAIN_NAME}";

    location / {
        if ($http_host = ${PUBLIC_DOMAIN_NAME}) {
            return 301 https://site.${PUBLIC_DOMAIN_NAME};
        }

        return 301 https://site.${PRIVATE_DOMAIN_NAME};
        # return 301 https://site.${DOMAIN_NAME};
    }
}

# Site
server {
    include     snippets/listen.conf;
    include     snippets/websites.conf;
    root        ${WEBSITES_ROOT};
    server_name "site.${PUBLIC_DOMAIN_NAME}" "site.${PRIVATE_DOMAIN_NAME}";
    #error_log   /var/log/nginx/error.log crit;
}

# FastDL
server {  
    include     snippets/listen.conf;
    server_name "fastdl.${PUBLIC_DOMAIN_NAME}" "fastdl.${PRIVATE_DOMAIN_NAME}";
    root        ${FASTDL_ROOT};
    
    location / {
        allow all;
        autoindex on;

        gzip on;
        gzip_disable "msie6";
        gzip_comp_level 6;
        
        limit_conn conn_limit 55;
        limit_req  zone=per_ip_rate burst=25 nodelay;
        
        if ($steam_user_agent) { 
            limit_rate_after  50m;
            limit_rate        15m;
        }
    }
    
    location ~* \.(lua|as|cfg|bak|txt|sh|so|exe|rc|lst|scr)$ {
        deny all;
    }
}

# Admin Panel
server {
    include            snippets/listen.conf;
    server_name        "admin.${PUBLIC_DOMAIN_NAME}" "admin.${PRIVATE_DOMAIN_NAME}";
    
    limit_rate 15m;
    limit_conn per_ip_conn 40;
    limit_req zone=per_ip_rate burst=45 delay=1;
    
    location / {
        proxy_pass "http://portainer:9000";
        proxy_http_version 1.1;
        proxy_set_header   Connection "";
        proxy_set_header   Host             $http_host;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        
        #proxy_pass         "http://portainer:9000";
        #proxy_set_header   Connection       $http_connection;
        #proxy_set_header   X-Scheme         $scheme;
        #proxy_cache_lock   on;
    }

    location /api/websocket/ {
        proxy_set_header   Upgrade $http_upgrade;
        proxy_set_header   Connection "upgrade";
        proxy_set_header   Host             $http_host;
        proxy_http_version 1.1;
        proxy_pass "http://portainer:9000/api/websocket/";
    }
}

# Search 
server {
    include     snippets/listen.conf;
    server_name "search.${PUBLIC_DOMAIN_NAME}" "search.${PRIVATE_DOMAIN_NAME}";
    
    location / {
        access_log /dev/null;
        error_log /dev/null;
        
        allow 127.0.0.0/8;
        allow 172.0.0.0/8;
        allow 192.0.0.0/8;
        include snippets/private/admin_ips.conf;
        deny all;

        proxy_pass "http://searxng:8080";
        proxy_set_header   Host             $http_host;
        proxy_set_header   Connection       $http_connection;
        proxy_set_header   X-Real-IP        $remote_addr;
        proxy_set_header   X-Forwarded-For  $proxy_add_x_forwarded_for;
        proxy_set_header   X-Scheme         $scheme;
        proxy_set_header   X-Script-Name    /searx;
        proxy_cache_lock   on;
    }
}
