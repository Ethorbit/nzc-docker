version: "3.9"
services:
  fail2ban_jail_envsubst:
    build:
      context: ./build/input_output_envsubst
      args:
        FILE_EXTENSION: "conf"
    env_file:
      - ../.ports.env
    volumes:
      - ./data/configs/fail2ban/template/jail.d:/mnt/input
      - ./data/configs/fail2ban/jail.d:/mnt/output
    network_mode: none
    cap_drop:
      - ALL
    cap_add:
      - CAP_DAC_OVERRIDE
      - CAP_FOWNER
    restart: on-failure
  fail2ban:
    build:
      context: ./build/fail2ban 
    cap_add:
      - NET_ADMIN
      - NET_RAW
    network_mode: host
    hostname: fail2ban
    command: '-f -x -v'
    volumes:
      - ./data/configs/fail2ban/jail.d:/etc/fail2ban/jail.d
      - fail2ban_logs:/logs
    depends_on:
      fail2ban_jail_envsubst:
        condition: service_completed_successfully
      fail2ban_rsyslog:
       condition: service_healthy
    logging:
      driver: syslog
      options:
        mode: non-blocking
        syslog-address: "tcp://localhost:${FAIL2BAN_RSYSLOG_PORT}"
        tag: "fail2ban"
    blkio_config:
      weight: 500
      device_write_bps:
        - path: ${DISK}
          rate: '30m'
      device_read_bps:
        - path: ${DISK}
          rate: '60m'
      device_read_iops:
        - path: ${DISK}
          rate: 100
      device_write_iops:
        - path: ${DISK}
          rate: 100
    cpu_shares: 512
    deploy:
      resources:
        limits:
          memory: 64M
        reservations:
          memory: 32M
    restart: unless-stopped
  fail2ban_rsyslog:
    command: '-n'
    tty: true
    stdin_open: true
    healthcheck:
      test: "/healthcheck.sh"
      start_period: 5s
      interval: 5s
      timeout: 10s
      retries: 3
    restart: always
    build:
      context: ./build/rsyslog
      args:
        - UID=${rsyslog_u}
        - GID=${fail2ban_g}
        - PORT=${FAIL2BAN_RSYSLOG_PORT}
    depends_on:
      rsyslog_permissions:
        condition: service_completed_successfully
    hostname: rsyslog_fail2ban
    ports:
      - 127.0.0.1:${FAIL2BAN_RSYSLOG_PORT}:${FAIL2BAN_RSYSLOG_PORT}/tcp
    volumes:
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ./data/configs/rsyslog/rsyslog.conf:/etc/rsyslog.conf
      - ./data/configs/logrotate/rsyslog.conf:/etc/logrotate.d/rsyslog
      - fail2ban_logs:/logs
      - ${MOUNT_PROC_CPUINFO}:/proc/cpuinfo:rw
      - ${MOUNT_PROC_MEMINFO}:/proc/meminfo:rw
      - ${MOUNT_PROC_SWAPS}:/proc/swaps:rw
      - ${MOUNT_PROC_STAT}:/proc/stat:rw
      - ${MOUNT_PROC_DISKSTATS}:/proc/diskstats:rw
      - ${MOUNT_PROC_UPTIME}:/proc/uptime:rw
      - ${MOUNT_PROC_SLABINFO}:/proc/slabinfo:rw
      - ${MOUNT_SYS_DEVICES_SYSTEM_CPU}:/sys/devices/system/cpu:rw
volumes:
  fail2ban_logs:
