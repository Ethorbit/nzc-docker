version: "3.9"
services:
  svencoop_permissions:
    build:
      context: ./build/permissions
    volumes:
      - svencoop:/mnt
    command: >
      /bin/sh -c 'chown "${steam_u}":"${svencoop_g}" /mnt 
      && chmod 2770 /mnt 
      && setfacl -d -m u::rwx,g::rwx,o::- /mnt'
    cap_drop:
      - ALL 
    cap_add:
      - CAP_DAC_OVERRIDE
      - CAP_CHOWN
      - CAP_FOWNER
      - CAP_FSETID
    network_mode: none
    restart: on-failure
  svencoop:
    build:
      context: ./build/svencoop-server
      args:
        PUID: ${steam_u}
        PGID: ${svencoop_g} 
        UMASK: "007"
    tty: true
    stdin_open: true
    environment:
      START_ARGS: "-port ${SVENCOOP_PORT:-28015} +maxplayers 12 +map uplink"
      RCON_PASSWORD: ${SVENCOOP_PASSWORD}
    volumes: 
      - /etc/localtime:/etc/localtime:ro
      - /etc/timezone:/etc/timezone:ro
      - ./data/configs/users/passwd:/etc/passwd:ro
      - ./data/configs/users/group:/etc/group:ro
      - ./data/configs/users/shadow:/etc/shadow:ro
      - ./data/configs/users/gshadow:/etc/gshadow:ro
      - svencoop:/home/steam/server
    depends_on:
      svencoop_permissions:
        condition: service_completed_successfully
      nginx_production: 
        condition: service_healthy
      nginx_development:
        condition: service_healthy
      rsyslog:
        condition: service_started
    ports:
      - ${SVENCOOP_PORT:-28015}:${SVENCOOP_PORT:-28015}/udp
    networks:
      - svencoop
      - mysql
    labels:
      - "io.portainer.accesscontrol.teams=svencoop"
    cpuset: ${SVENCOOP_CPU}
    cpu_count: 1
    cpu_shares: 256
    deploy:
      resources:
        limits:
          memory: 512M 
        reservations:
          memory: 128M  
    blkio_config:
      weight: 150
      device_write_bps:
        - path: ${DISK}
          rate: 10000000
      device_read_bps:
        - path: ${DISK}
          rate: 20000000
      device_read_iops:
        - path: ${DISK}
          rate: 120
      device_write_iops:
        - path: ${DISK}
          rate: 100
    logging:
      driver: syslog
      options:
        mode: non-blocking
        syslog-address: "tcp://localhost:${RSYSLOG_PORT}"
        tag: "svencoop"
    restart: always
volumes:
  svencoop:
networks: 
  svencoop:
    driver: "bridge"
