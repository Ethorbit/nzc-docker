version: "3.9"
x-nginx: &nginx
  build:
    context: ./build/nginx
    args:
      UID: ${NGINX_UID}
      GID: ${NZC_GID}
  networks:
    - nginx
  ports:
    - ${NGINX_HTTP_PORT:-80}:80
    - ${NGINX_HTTPS_PORT:-443}:443
  healthcheck:
    test: "curl -f http://${DOMAIN_NAME} || exit 1"
    start_period: 5s
    interval: 10s
    timeout: 10s
    retries: 3
  environment:
    - DOMAIN_NAME=${DOMAIN_NAME}
  cpuset: ${NGINX_CPU}
  cpu_percent: 30
  cpu_shares: 2048
  deploy:
    resources:
      limits:
        memory: 1024M
      reservations:
        memory: 512M
  blkio_config:
    weight: 800
    device_write_bps:
      - path: ${DISK}
        rate: 50000000
    device_read_bps:
      - path: ${DISK}
        rate: 50000000
    device_read_iops:
      - path: ${DISK}
        rate: 100
    device_write_iops:
      - path: ${DISK}
        rate: 100
  restart: unless-stopped
x-nginx_envsubst_conf: &nginx_envsubst_conf
  build:
    context: ./build/nginx_envsubst
  volumes:
    - ./data/nginx/conf.d.template:/mnt/input
    - ./data/nginx/conf.d:/mnt/output
  network_mode: none
  cap_drop:
    - ALL
x-nginx_envsubst_snippets: &nginx_envsubst_snippets
  build:
    context: ./build/nginx_envsubst
  volumes:
    - ./data/nginx/snippets.template:/mnt/input
    - ./data/nginx/snippets:/mnt/output
  network_mode: none
  cap_drop:
    - ALL
x-nginx_envsubst_production: &nginx_envsubst_production
  profiles:
    - production
  environment:  
    - DOMAIN_NAME=${DOMAIN_NAME}
    - NGINX_SSL_CERT="/etc/letsencrypt/live/chronicles.local/cert.pem"
    - NGINX_SSL_CERT_KEY="/etc/letsencrypt/live/chronicles.local/privkey.pem"
    - NGINX_SSL_DHPARAM="/etc/letsencrypt/ssl-dhparams.pem" 
x-nginx_envsubst_development: &nginx_envsubst_development
  profiles:
    - development
  environment:
    - DOMAIN_NAME=${DOMAIN_NAME}
    - NGINX_SSL_CERT="/etc/mkcert/mkcert.pem"
    - NGINX_SSL_CERT_KEY="/etc/mkcert/mkcert.key"
    - NGINX_SSL_DHPARAM="/etc/mkcert/mkcert.dh"
services:
  nginx_permissions:
    image: alpine:latest
    volumes:
      - nginx_websites:/mnt/nginx_websites
      - nginx_cpu:/mnt/nginx_cpu
      - ./data/nginx:/mnt/nginx_conf
      - mkcert:/mnt/mkcert
      - certbot_conf:/mnt/certbot_conf
      - certbot_www:/mnt/certbot_www
    command: >
      /bin/sh -c "echo \"${NGINX_CPU}\" > /mnt/nginx_cpu/online
      && mkdir -p /mnt/nginx_websites/fastdl/nzc/svencoop
      && mkdir -p /mnt/nginx_websites/fastdl/nzc/gmod
      && chown ${NGINX_UID}:${NZC_GID} 
      /mnt/nginx_websites/fastdl 
      /mnt/nginx_websites/fastdl/nzc 
      /mnt/nginx_websites/fastdl/nzc/svencoop 
      /mnt/nginx_websites/fastdl/nzc/gmod
      && chown -R root:root /mnt/nginx_conf/
      && chown -fR ${NGINX_UID}:root /mnt/mkcert/
      && if [ -f '/mnt/certbot_conf/ssl-dhparams.pem' ]; then
        chown -f ${NGINX_UID}:root /mnt/certbot_conf/ssl-dhparams.pem
      fi
      && if [ -d '/mnt/certbot_conf/live/' ]; then
        chown -fR ${NGINX_UID}:root /mnt/certbot_conf/live/
      fi"
    network_mode: none
    cap_drop:
      - ALL 
    cap_add:
      - CAP_DAC_OVERRIDE
      - CHOWN
    depends_on:
      certbot:
        condition: service_started
      mkcert:
        condition: service_completed_successfully
      openssl:
        condition: service_completed_successfully
    restart: on-failure
  # Production nginx, for use only on a machine the real domain is pointing to.
  certbot:
    image: certbot/certbot:latest
    profiles:
      - production
    volumes:
      - certbot_conf:/etc/letsencrypt
      - certbot_www:/var/www/certbot
    networks:
      - nginx
    restart: unless-stopped       
  nginx_envsubst_conf_production:
    <<: *nginx_envsubst_conf
    profiles:
      - production 
  nginx_envsubst_conf_production:
    <<: *nginx_envsubst_conf
    <<: *nginx_envsubst_production
  nginx_envsubst_snippets_production:
    <<: *nginx_envsubst_snippets
    <<: *nginx_envsubst_production
  nginx_production: 
    <<: *nginx  
    profiles:
      - production
    volumes:  
      - nginx_cpu:/sys/devices/system/cpu:ro
      - nginx_websites:/usr/share/nginx/html   
      - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./data/nginx/snippets:/etc/nginx/snippets
      - ./data/nginx/conf.d:/etc/nginx/conf.d 
      - svencoop:/usr/share/nginx/html/fastdl/svencoop:ro
      - certbot_conf:/etc/letsencrypt    
      - certbot_www:/var/www/certbot 
    depends_on:
      nginx_envsubst_conf_production:
        condition: service_completed_successfully 
      nginx_envsubst_snippets_production:
        condition: service_completed_successfully
      nginx_permissions:
        condition: service_completed_successfully
  # Development nginx (because Let's Encrypt only works on the actual domain)
  mkcert:
    image: ethorbit/mkcert:latest
    profiles:
      - development
    volumes:
      - ${CA_TRUST_STORE_DIR:-/usr/local/share/ca-certificates}:/usr/local/share/ca-certificates
      - mkcert:/mnt
    command: > 
      /bin/sh -c "[[ ! -s /mnt/mkcert.pem || ! -s /mnt/mkcert.key ]]
      && mkcert -install
      && mkcert -cert-file /mnt/mkcert.pem -key-file /mnt/mkcert.key
      *.${DOMAIN_NAME} 
      || exit 0" 
    network_mode: none 
  openssl:
    image: ethorbit/openssl:latest
    profiles:
      - development
    volumes:
      - mkcert:/mnt
    command: >
      /bin/sh -c "[[ ! -s /mnt/mkcert.dh ]]
      && openssl dhparam -out /mnt/mkcert.dh 2048
      || exit 0"
  nginx_dnsmasq:
    image: ethorbit/dnsmasq:latest
    profiles:
      - development
    volumes:
      - ./data/nginx/dnsmasq/dnsmasq.conf:/etc/dnsmasq.conf
    ports:
      - 53/udp
    networks:
      nginx:
        ipv4_address: 172.10.1.1
  nginx_envsubst_conf_development:
    <<: *nginx_envsubst_conf
    <<: *nginx_envsubst_development
  nginx_envsubst_snippets_development:
    <<: *nginx_envsubst_snippets
    <<: *nginx_envsubst_development
  nginx_envsubst_dnsmasq_development:
    image: ethorbit/envsubst:latest
    volumes:
      - ./data/nginx/dnsmasq:/mnt
    command: >
      /bin/sh -c "envsubst `printf '$${%s}\n' DOMAIN_NAME` 
      < /mnt/dnsmasq.conf.template > /mnt/dnsmasq.conf"
    environment:
      - DOMAIN_NAME=${DOMAIN_NAME}
    network_mode: none
    cap_drop:
      - ALL
  nginx_development:
    <<: *nginx
    profiles:
      - development
    volumes:   
      - nginx_cpu:/sys/devices/system/cpu:ro
      - nginx_websites:/usr/share/nginx/html 
      - ./data/nginx/nginx.conf:/etc/nginx/nginx.conf
      - ./data/nginx/snippets:/etc/nginx/snippets
      - ./data/nginx/conf.d:/etc/nginx/conf.d
      - svencoop:/usr/share/nginx/html/fastdl/svencoop:ro
      - mkcert:/etc/mkcert
    dns:
      - 172.10.1.1
    depends_on:
      nginx_envsubst_conf_development:
        condition: service_completed_successfully 
      nginx_envsubst_snippets_development:
        condition: service_completed_successfully
      nginx_permissions:
        condition: service_completed_successfully
      nginx_dnsmasq:
        condition: service_started
volumes:
  nginx_cpu:
  nginx_websites:
  certbot_conf:
  certbot_www:
  mkcert:
networks:
  nginx:
    ipam:
      driver: default
      config:
        - subnet: 172.10.0.0/23
