version: "3.9"
x-defaults: &defaults 
  blkio_config:
    weight: 500
    device_write_bps:
      - path: ${DISK}
        rate: 60000000
    device_read_bps:
      - path: ${DISK}
        rate: 60000000
    device_read_iops:
      - path: ${DISK}
        rate: 200
    device_write_iops:
      - path: ${DISK}
        rate: 200      
x-unionfs: &unionfs 
  image: ethorbit/unionfs:latest
  <<: *defaults 
  privileged: true    
  network_mode: none    
  environment:    
    TZ: ${TZ}    
    PUID: ${GMOD_UID}    
    PGID: ${SFTP_GID}  
  cpu_shares: 256
  deploy:
    resources:
      limits:
        memory: 50M 
  restart: unless-stopped 
x-gmod-environment: &gmod-environment
  SRCDS_APPID: 4020 
  USER_ID: ${GMOD_UID} 
  GROUP_ID: ${GMOD_GID}    
x-gmod: &gmod
  image: ethorbit/srcds-server  
  <<: *defaults
  stdin_open: true
  tty: true
  environment:
    <<: *gmod-environment
  cpu_count: 1
  cpu_shares: 1024 
  deploy:
    resources:
      limits:
        memory: 512M
      reservations:
        memory: 256M
  healthcheck: 
    interval: 1s
    start_period: 2s
    retries: 180 
  networks:
    - gmod
  restart: unless-stopped 
networks:
  gmod:
    driver: "bridge"
services:     
  unionfs-1:
    <<: *unionfs
    cpuset: "0"
    volumes:
      - gmod_shared:/bottom:shared
      - gmod_1:/top:shared
      - gmod_1_merged:/merged:shared
  gmod-1:
    <<: *gmod
    cpuset: "0"
    environment:
      <<: *gmod-environment
      SRCDS_RUN_ARGS: "-tickrate 33 -disableluarefresh -port 27015 +maxplayers 15 +gamemode sandbox +map gm_flatgrass"
    volumes:
      - gmod_1:/home/srcds/server
    ports:
      - 27015:27015/udp
    depends_on:
      unionfs-1:
        condition: service_started 
    healthcheck:
      test: ["CMD-SHELL", "findmnt /media/ssd/docker | grep gmod_1_merged | grep unionfs"]     
  unionfs-2:
    <<: *unionfs
    cpuset: "2"
    volumes:
      - gmod_shared:/bottom:shared
      - gmod_2:/top:shared
      - gmod_2_merged:/merged:shared
  gmod-2:
    <<: *gmod
    cpuset: "2"
    environment:
      <<: *gmod-environment
      SRCDS_RUN_ARGS: "-tickrate 33 -disableluarefresh -port 27016 +maxplayers 15 +gamemode sandbox +map gm_flatgrass"
    volumes:
      - gmod_2:/home/srcds/server
    ports:
      - 27016:27016/udp
    depends_on:
      unionfs-2:
        condition: service_started 
    healthcheck:
      test: ["CMD-SHELL", "findmnt /media/ssd/docker | grep gmod_2_merged | grep unionfs"]     
  unionfs-3:
    <<: *unionfs
    cpuset: "4"
    volumes:
      - gmod_shared:/bottom:shared
      - gmod_3:/top:shared
      - gmod_3_merged:/merged:shared
  gmod-3:
    <<: *gmod
    cpuset: "4"
    environment:
      <<: *gmod-environment
      SRCDS_RUN_ARGS: "-tickrate 33 -disableluarefresh -port 27017 +maxplayers 15 +gamemode sandbox +map gm_flatgrass"
    volumes:
      - gmod_3:/home/srcds/server
    ports:
      - 27017:27017/udp
    depends_on:
      unionfs-3:
        condition: service_started 
    healthcheck:
      test: ["CMD-SHELL", "findmnt /media/ssd/docker | grep gmod_3_merged | grep unionfs"]
volumes:
  gmod_shared:   
  gmod_1: 
  gmod_1_merged:   
  gmod_2: 
  gmod_2_merged:   
  gmod_3: 
  gmod_3_merged: 
